version: '3.8'

services:
  cfst-ddns:
    # 使用预构建的 Docker Hub 镜像
    image: lonelyman0108/cfst-ddns:latest

    # 如果需要从源码构建，请注释上面的 image 行，取消注释下面两行
    # build: .
    # image: cfst-ddns:latest

    container_name: cfst-ddns

    environment:
      - TZ=Asia/Shanghai
      - AUTO_INSTALL_CFST=true

      # CloudflareSpeedTest 版本号（可选，当 GitHub API 访问失败时使用）
      # - CFST_VERSION=v2.2.5

      # GitHub 镜像站点（可选，加速下载 CloudflareSpeedTest）
      # - GITHUB_MIRROR=https://你的镜像站点

      # 启用定时任务模式
      # 定时任务模式: ENABLE_CRON=true (配合 restart: unless-stopped)
      # 单次执行模式: ENABLE_CRON=false (不需要 restart 策略)
      - ENABLE_CRON=true

      # 定时任务执行频率（cron 表达式）
      # 仅在 ENABLE_CRON=true 时生效
      # 默认: 每6小时执行一次
      # 其他示例:
      #   每天凌晨3点: 0 3 * * *
      #   每小时: 0 * * * *
      #   每12小时: 0 */12 * * *
      #   每30分钟: */30 * * * *
      - CRON_SCHEDULE=0 */6 * * *

    volumes:
      - ./data:/app/data
      - ./cfst:/app/cfst
      - ./logs:/var/log

    # 自动重启策略
    # 定时任务模式需要此配置，单次执行模式请注释掉
    restart: unless-stopped

    network_mode: host

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ==================== 使用说明 ====================
#
# 方式一：定时任务模式（推荐，后台持续运行）
#   docker-compose up -d
#   - 容器会持续运行，按 CRON_SCHEDULE 定时执行
#   - 使用 restart: unless-stopped 确保容器异常退出后自动重启
#   - 查看日志: docker-compose logs -f cfst-ddns
#
# 方式二：单次执行模式
#   1. 修改环境变量: ENABLE_CRON=false
#   2. 注释掉 restart: unless-stopped
#   3. 执行: docker-compose run --rm cfst-ddns
#   - 执行完成后容器自动退出和删除
#
# 修改定时任务频率：
#   编辑 CRON_SCHEDULE 环境变量，然后重启:
#   docker-compose restart cfst-ddns
#
